name: Auto-Merge PR

on:
  workflow_run:
    workflows: ["API Build + Test"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v3

      - name: ü§ñ Merge PR and delete branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflow_run = context.payload.workflow_run;

            // Garante que o workflow de build est√° vinculado a um PR
            if (!workflow_run.pull_requests || workflow_run.pull_requests.length === 0) {
              core.info("No PR associated with this workflow run. Exiting.");
              return;
            }

            const pr_number = workflow_run.pull_requests[0].number;

            // Get current PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            // Verify if PR is open and merbeable
            if (pr.state !== 'open') {
              core.setFailed(`PR #${pr_number} is not open.`);
              return;
            }
            if (!pr.mergeable) {
              core.setFailed(`PR #${pr_number} is not mergeable.`);
              return;
            }

            // Faz o merge autom√°tico
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number,
              merge_method: 'squash' // pode ser merge ou rebase
            });
            core.info(`‚úÖ PR #${pr_number} merged successfully.`);

            // Deleta a branch do PR, se n√£o for main/master
            const branch = pr.head.ref;
            if (branch !== 'main' && branch !== 'master') {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`
              });
              core.info(`üóëÔ∏è Branch '${branch}' deleted.`);
            }
