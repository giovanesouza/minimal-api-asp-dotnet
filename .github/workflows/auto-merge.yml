name: Auto-Merge PR

on:
  workflow_run:
    workflows: ["API Build + Test"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v3

      - name: ü§ñ Merge PR and delete branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sha = context.payload.workflow_run.head_sha;

            // Try to find the Pull Request associated with this commit
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });

            if (prs.length === 0) {
              core.info("‚ö†Ô∏è No Pull Request found for this commit. Exiting.");
              return;
            }

            const pr = prs[0];
            const pr_number = pr.number;
            core.info(`üîç Found Pull Request #${pr_number} for this commit.`);

            // Fetch PR details to verify its current state
            const { data: currentPR } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            // Ensure the PR is open and mergeable
            if (currentPR.state !== 'open') {
              core.setFailed(`Pull Request #${pr_number} is not open.`);
              return;
            }

            if (currentPR.mergeable === false) {
              core.setFailed(`Pull Request #${pr_number} is not mergeable.`);
              return;
            }

            // Perform the merge using the desired merge method
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number,
              merge_method: 'squash' // other options: 'merge' or 'rebase'
            });
            core.info(`‚úÖ Pull Request #${pr_number} merged successfully.`);

            // Delete the branch after merging (except for main/master)
            const branch = currentPR.head.ref;
            if (branch !== 'main' && branch !== 'master') {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`
              });
              core.info(`üóëÔ∏è Branch '${branch}' deleted.`);
            }
