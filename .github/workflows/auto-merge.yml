name: Auto Merge PR

on:
  repository_dispatch:
    types: [trigger-auto-merge]

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ”„ Checkout
      uses: actions/checkout@v3

    - name: ðŸ§¾ Merge PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pr_number = context.payload.client_payload.pr_number;
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr_number
          });

          if (pr.state !== 'open') {
            core.setFailed(`PR #${pr_number} is not open.`);
            return;
          }

          if (!pr.mergeable) {
            core.setFailed(`PR #${pr_number} is not mergeable.`);
            return;
          }

          await github.rest.pulls.merge({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr_number,
            merge_method: 'merge' // 'merge', 'squash' or 'rebase'
          });

          // Delete the PR branch (if it different of the main/master branch)
          const branch = pr.head.ref;
          if (branch !== 'main' && branch !== 'master') {
            await github.rest.git.deleteRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branch}`
            });
          }