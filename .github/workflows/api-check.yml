name: API CI/CD

# ğŸš€ This workflow runs on pushes and pull requests targeting the "main" branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ—ï¸ Build job
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      # ğŸ”„ Step 1: Checkout the repository
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Install the .NET SDK
      - name: ğŸ§° Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ“¦ Step 3: Restore NuGet dependencies
      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore ./Api/MinimalApi.csproj

      # ğŸ› ï¸ Step 4: Build the project in Release mode
      - name: ğŸ› ï¸ Build the project
        run: dotnet build ./Api/MinimalApi.csproj --no-restore --configuration Release

  # ğŸ§ª Test job
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build # â³ Wait for the build job to finish successfully

    steps:
      # ğŸ”„ Step 1: Checkout the repository
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Install the .NET SDK
      - name: ğŸ§° Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ§ª Step 3: Run unit tests and generate a .trx report
      - name: ğŸ§ª Run tests and generate .trx report
        run: |
          # Create a directory to store test results
          mkdir -p TestResults

          # Run tests using the .NET CLI
          # - --no-build: skip rebuilding since build job already did it
          # - --logger "trx": generate a TRX test report file
          # - --results-directory: specify where to save results
          # - --verbosity normal: display detailed test output
          dotnet test ./Test/Test.csproj \
            --no-build \
            --configuration Release \
            --logger "trx;LogFileName=$(pwd)/TestResults/test-results.trx" \
            --results-directory $(pwd)/TestResults \
            --verbosity normal

          echo "âœ… Test execution completed."

      # ğŸ“„ Step 4: Upload the test results as an artifact
      - name: ğŸ“„ Upload test results (.trx)
        if: always() # Always upload even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/test-results.trx
