name: API CI/CD

# ğŸš€ This workflow runs on pushes and pull requests targeting the "main" branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ—ï¸ Build job
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      # ğŸ”„ Step 1: Checkout the repository
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Install the .NET SDK
      - name: ğŸ§° Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ“¦ Step 3: Restore NuGet dependencies
      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore ./Api/MinimalApi.csproj

      # ğŸ› ï¸ Step 4: Build the project in Release mode
      - name: ğŸ› ï¸ Build the project
        run: dotnet build ./Api/MinimalApi.csproj --no-restore --configuration Release


  # ğŸ§ª Test job
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build # â³ Wait for the build job to finish successfully

    steps:
      # ğŸ”„ Step 1: Checkout the repository
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Install the .NET SDK
      - name: ğŸ§° Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ§ª Run unit tests
      - name: ğŸ§ª Run tests and generate .trx report
        run: |
          echo "ğŸ§© Starting automated tests..."
          dotnet test ./Test/Test.csproj \
            --logger "console;verbosity=detailed" \
            --logger "trx;LogFileName=test_results.trx" \
            --results-directory ./Test/TestResults
          echo "âœ… Test execution completed."
  
      # ğŸ“Š Generate HTML report
      - name: ğŸ“Š Convert TRX to HTML report
        run: |
          echo "ğŸ§° Installing ReportGenerator..."
          dotnet tool install -g dotnet-reportgenerator-globaltool
          echo "ğŸ§¾ Generating HTML report..."
          reportgenerator \
            -reports:./Test/TestResults/test_results.trx \
            -targetdir:./Test/TestResults/Report \
            -reporttypes:Html
          echo "ğŸ“„ HTML report generated at ./Test/TestResults/Report/index.html"
  
      # ğŸ“¤ Upload the HTML report (optional but useful)
      - name: ğŸ“¤ Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-test-report
          path: Test/TestResults/Report
  
      # ğŸ‰ Summary
      - name: ğŸ‰ Final summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All tests executed."
          echo "ğŸ“Š HTML report generated and uploaded."
          echo "ğŸ“ Download it from the 'Artifacts' section."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
