name: API CI/CD

# ğŸš€ This workflow runs on pushes and pull requests targeting the "main" branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ—ï¸ Build job
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      # ğŸ”„ Step 1: Checkout the repository
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Install the .NET SDK
      - name: ğŸ§° Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ“¦ Step 3: Restore NuGet dependencies
      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore ./Api/MinimalApi.csproj

      # ğŸ› ï¸ Step 4: Build the project in Release mode
      - name: ğŸ› ï¸ Build the project
        run: dotnet build ./Api/MinimalApi.csproj --no-restore --configuration Release

  # ğŸ§ª Test job
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build # â³ Wait for the build job to finish successfully

    steps:
      # ğŸ”„ Step 1: Checkout the repository
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Install the .NET SDK
      - name: ğŸ§° Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ§ª Step 3: Run unit tests and generate a .trx report
        # Run tests using the .NET CLI
        # - --no-build: skip rebuilding since build job already did it
        # - --logger "trx": generate a TRX test report file
        # - --results-directory: specify where to save results
        # - --verbosity normal: display detailed test output
      - name: ğŸ§ª Run tests and generate .trx report
        run: |
          echo "ğŸ§© Starting test execution..."
          mkdir -p TestResults

          dotnet test ./Test/Test.csproj \
            --no-build \
            --configuration Release \
            --logger "trx;LogFileName=$(pwd)/TestResults/test-results.trx" \
            --results-directory $(pwd)/TestResults \
            --verbosity detailed

          echo "âœ… Test execution completed successfully!"

      # ğŸ§Š Step 4: Convert TRX to HTML report
      - name: ğŸ“Š Convert TRX to HTML report
        run: |
          echo "ğŸ§° Installing trx2html tool..."
          dotnet tool install -g trx2html

          echo "ğŸ§¾ Generating HTML report from TRX file..."
          trx2html TestResults/test-results.trx TestResults/test-report.html

          echo "ğŸ“„ HTML report successfully generated at TestResults/test-report.html"

      # ğŸ“„ Step 5: Upload the test results (.trx)
      - name: ğŸ“„ Upload test results (.trx)
        if: always() # Always upload even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/test-results.trx

      # ğŸŒ Step 6: Upload the HTML report
      - name: ğŸ“¤ Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-test-report
          path: TestResults/test-report.html

      # ğŸ‰ Step 7: Final summary message
      - name: ğŸ‰ Final summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All tests executed."
          echo "ğŸ“¦ TRX and HTML reports uploaded as artifacts."
          echo "ğŸ“ You can download them from the 'Artifacts' section."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          