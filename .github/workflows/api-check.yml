name: API CI/CD

# ğŸš€ This workflow runs on pushes and pull requests targeting the "main" branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ—ï¸ Build job
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      # ğŸ”„ Step 1: Checkout the repository
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Install the .NET SDK
      - name: ğŸ§° Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ“¦ Step 3: Restore NuGet dependencies
      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore ./Api/MinimalApi.csproj

      # ğŸ› ï¸ Step 4: Build the project in Release mode
      - name: ğŸ› ï¸ Build the project
        run: dotnet build ./Api/MinimalApi.csproj --no-restore --configuration Release


  # ğŸ§ª Test job
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build # â³ Wait for the build job to finish successfully

    steps:
      # ğŸ”„ Step 1: Checkout the repository
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Install the .NET SDK
      - name: ğŸ§° Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # ğŸ§ª Step 3: Run tests and show results
      - name: ğŸ§ª Run tests and show output
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§© Starting automated tests..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Run tests with detailed verbosity so individual test names appear
          dotnet test --logger "console;verbosity=detailed" | tee TestOutput.log

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Test Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Extract summary stats from the output (Passed, Failed, Skipped)
          PASSED=$(grep -oP 'Passed: \K[0-9]+' TestOutput.log | tail -1)
          FAILED=$(grep -oP 'Failed: \K[0-9]+' TestOutput.log | tail -1)
          SKIPPED=$(grep -oP 'Skipped: \K[0-9]+' TestOutput.log | tail -1)
          TOTAL=$(grep -oP 'Total: \K[0-9]+' TestOutput.log | tail -1)

          echo "âœ… Passed: ${PASSED:-0} | âŒ Failed: ${FAILED:-0} | âš ï¸ Skipped: ${SKIPPED:-0} | ğŸ“Š Total: ${TOTAL:-0}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ Test run completed."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

